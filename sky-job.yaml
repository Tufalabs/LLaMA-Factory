resources:
  image_id: kevinlopezandrade/nccl-tests:latest
  cloud: kubernetes
  accelerators: B200:8
  cpus: 32
  memory: 220

workdir: .

envs:
  MODEL_NAME: null
  MODEL_REVISION: null
  DATASET: open-thoughts-2

file_mounts:
  ~/.env: ~/tufa/.env

setup: |
  set -e
  conda config --set auto_activate_base false

run: |
  set -e
  conda deactivate
  set -a; . ~/.env; set +a
  export PROJECT=OpenThoughts-SFT-ablations
  export WANDB_PROJECT=${PROJECT}
  export CONFIG=${MODEL_NAME}_sft_${DATASET}
  export RUN_NAME=${MODEL_NAME}_${MODEL_REVISION}

  apt-get install python3-dev -y
  uv sync --extra torch --extra metrics
  source .venv/bin/activate
  llamafactory-cli train configs/${CONFIG}.yaml \
    model_revision=${MODEL_REVISION} \
    output_dir=/mnt/checkpoints/${PROJECT}/${DATASET}/${RUN_NAME} \
    run_name=${RUN_NAME}

config:
  kubernetes:
    provision_timeout: 20
    pod_config:
      spec:
        nodeSelector:
          node-type: queued
        containers:
          - volumeMounts:
              - mountPath: /mnt/checkpoints
                name: nfs-checkpoints
              - mountPath: /mnt/logs
                name: nfs-logs
              - mountPath: /mnt/artifacts
                name: nfs-artifacts
              - mountPath: /mnt/builds
                name: nfs-builds
              - mountPath: /mnt/datasets
                name: nfs-datasets
        volumes:
          - name: nfs-checkpoints
            nfs:
              server: 10.100.0.253
              path: /data/shared/checkpoints
              readOnly: false
          - name: nfs-logs
            nfs:
              server: 10.100.0.253
              path: /data/shared/logs
              readOnly: false
          - name: nfs-artifacts
            nfs:
              server: 10.100.0.253
              path: /data/shared/artifacts
              readOnly: false
          - name: nfs-builds
            nfs:
              server: 10.100.0.253
              path: /data/shared/builds
              readOnly: true
          - name: nfs-datasets
            nfs:
              server: 10.100.0.253
              path: /data/shared/datasets
              readOnly: false
