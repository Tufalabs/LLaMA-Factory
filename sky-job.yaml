resources:
  image_id: kevinlopezandrade/nccl-tests:latest
  cloud: kubernetes
  accelerators: B200:8
  cpus: 32
  memory: 220

workdir: .

envs:
  PROJECT: OpenThoughts-SFT-ablations
  MODEL_NAME: olmo-2-0425-1B
  MODEL_REVISION: NA  # Should be specified manually

file_mounts:
  ~/.env: ~/tufa/.env
  ~/.netrc: ~/.netrc  # For wandb login

setup: |
  set -e
  conda config --set auto_activate_base false

run: |
  set -e
  conda deactivate
  export WANDB_PROJECT=${PROJECT}
  export CONFIG=${MODEL_NAME}_sft_open-thoughts-2
  export RUN_NAME=${MODEL_NAME}_${MODEL_REVISION}

  uv sync --extra torch --extra metrics
  source .venv/bin/activate
  llamafactory-cli train configs/${CONFIG}.yaml \
    model_revision=${MODEL_REVISION} \
    output_dir=/mnt/checkpoints/${PROJECT}/${RUN_NAME} \
    run_name=${RUN_NAME}

config:
  kubernetes:
    provision_timeout: 20
    pod_config:
      spec:
        nodeSelector:
          node-type: queued
        containers:
          - volumeMounts:
              - mountPath: /mnt/checkpoints
                name: nfs-checkpoints
              - mountPath: /mnt/logs
                name: nfs-logs
              - mountPath: /mnt/artifacts
                name: nfs-artifacts
              - mountPath: /mnt/builds
                name: nfs-builds
              - mountPath: /mnt/datasets
                name: nfs-datasets
        volumes:
          - name: nfs-checkpoints
            nfs:
              server: 10.100.0.253
              path: /data/shared/checkpoints
              readOnly: false
          - name: nfs-logs
            nfs:
              server: 10.100.0.253
              path: /data/shared/logs
              readOnly: false
          - name: nfs-artifacts
            nfs:
              server: 10.100.0.253
              path: /data/shared/artifacts
              readOnly: false
          - name: nfs-builds
            nfs:
              server: 10.100.0.253
              path: /data/shared/builds
              readOnly: true
          - name: nfs-datasets
            nfs:
              server: 10.100.0.253
              path: /data/shared/datasets
              readOnly: false
